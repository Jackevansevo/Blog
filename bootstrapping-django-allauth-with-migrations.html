<!DOCTYPE html>
<html lang="en">
<head>
          <title>Jack's Blog - Bootstrapping django-allauth with migrations</title>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="/theme/css/main.css" />
        <link rel="shortcut icon" type="image/x-icon" href="/theme/favicon.ico">




    <meta name="tags" content="python" />
    <meta name="tags" content="django" />

</head>

<body>
        <header>
                <h1><a href="/">Jack's Blog</a></h1>
        </header>
        <nav><ul>
        </ul></nav>
        <main>
  <header>
    <h1 class="entry-title">
      <a href="/bootstrapping-django-allauth-with-migrations.html" rel="bookmark"
         title="Permalink to Bootstrapping django-allauth with migrations">Bootstrapping django-allauth with migrations</a></h1>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2022-08-06T00:00:00+01:00">
      Sat 06 August 2022
    </time>
    <address class="vcard author">
      By           <a class="url fn" href="/author/jack-evans.html">Jack Evans</a>
    </address>
    <div class="category">
        Category: <a href="/category/python.html">Python</a>
    </div>
    <div class="tags">
        Tags:
            <a href="/tag/python.html">python</a>
            <a href="/tag/django.html">django</a>
    </div>
  </footer><!-- /.post-info -->
  <article>
    <p>Recently I added
<a href="https://django-allauth.readthedocs.io/en/latest/index.html">django-allauth</a> to
my site, to enable logging in with third party auth providers (such as Google). </p>
<h2>Allauth docuemntation</h2>
<p>As per the <a href="https://django-allauth.readthedocs.io/en/latest/installation.html#post-installation">installation
instructions</a>
allauth recommends the following:</p>
<ul>
<li>Add a <code>Site</code> for your domain, matching <code>settings.SITE_ID</code> (<code>django.contrib.sites</code> app).</li>
<li>For each OAuth based provider, either add a <code>SocialApp</code> (<code>socialaccount</code> app) containing the required client credentials, or, make sure that these are configured via the <code>SOCIALACCOUNT_PROVIDERS[&lt;provider&gt;]['APP']</code> setting (see example above).</li>
</ul>
<h2>Django documentation</h2>
<p>According to the <a href="https://docs.djangoproject.com/en/4.0/ref/contrib/sites/#enabling-the-sites-framework">Django documentation</a></p>
<p><code>django.contrib.sites</code> registers a <code>post_migrate</code> signal handler which creates
a default site named <code>example.com</code> with the domain <code>example.com</code>. This site
will also be created after Django creates the test database. To set the correct
name and domain for your project, you can use a <a href="https://docs.djangoproject.com/en/4.0/topics/migrations/#data-migrations">data migration</a>.</p>
<h2>The problem</h2>
<p>The default <code>example.com</code> site isn't particularly useful default when working
with the <code>allauth</code> package.</p>
<p>This configuration requires you to manually head into the admin to:
- Create a new site for <code>localhost:8000</code> (or however you're developing locally)
- Create a new <code>SocialApp</code> for each provider (<code>google</code> in my case) along with
  respective secrets, then link to your created site</p>
<p>This is required every time you have to bootstrap your environment, i.e. when
cloning the project on a new machine, or after wiping your DB.</p>
<p>I wanted a mechanism to be able to quickly bootstrap my project during
development across machines with minimal manual intervention.</p>
<p>The docs indicate a
<a href="https://docs.djangoproject.com/en/4.0/topics/migrations/#module-django.db.migrations">migration</a>
can be used to set a <em>correct name and domain for your project</em> but doesn't
specify how.</p>
<h2>Solution</h2>
<p>After a bit of googling I came up with:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib.sites.models</span> <span class="kn">import</span> <span class="n">Site</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">migrations</span>


<span class="k">def</span> <span class="nf">create_site</span><span class="p">(</span><span class="n">apps</span><span class="p">,</span> <span class="n">schema_editor</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">site</span> <span class="o">=</span> <span class="n">Site</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s2">&quot;localhost:8000&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Migration</span><span class="p">(</span><span class="n">migrations</span><span class="o">.</span><span class="n">Migration</span><span class="p">):</span>

    <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;feeds&quot;</span><span class="p">,</span> <span class="s2">&quot;0001_initial&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;sites&quot;</span><span class="p">,</span> <span class="s2">&quot;0002_alter_domain_unique&quot;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">operations</span> <span class="o">=</span> <span class="p">[</span><span class="n">migrations</span><span class="o">.</span><span class="n">RunPython</span><span class="p">(</span><span class="n">create_site</span><span class="p">)]</span>
</code></pre></div>

<p><code>feeds</code> is the name of the app I'm developing, and <code>sites</code> refers to the
builtin <code>django.contrib.sites</code> app (added to <code>INSTALLED_APPS</code>). By specifying
these as dependencies this ensures the migration is ran only once these have
completed.</p>
<p><strong>Note</strong> it's possible to manually create blank migrations on a per app basis (not from models) with: </p>
<div class="highlight"><pre><span></span><code>./manage.py makemigrations &lt;app&gt; --empty
</code></pre></div>

<hr>
<p>This alone isn't sufficient to bootstrap a working project with
allauth. Allauth still requires an additional <code>SocialApp</code> integration to be
created and linked to your site.</p>
<p>Fortunately this is fairly trivial to extend:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">allauth.socialaccount.models</span> <span class="kn">import</span> <span class="n">SocialApp</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib.sites.models</span> <span class="kn">import</span> <span class="n">Site</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">migrations</span>


<span class="k">def</span> <span class="nf">create_site</span><span class="p">(</span><span class="n">apps</span><span class="p">,</span> <span class="n">schema_editor</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">site</span> <span class="o">=</span> <span class="n">Site</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s2">&quot;localhost:8000&quot;</span><span class="p">)</span>
        <span class="n">social_app</span> <span class="o">=</span> <span class="n">SocialApp</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">provider</span><span class="o">=</span><span class="s2">&quot;google&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;google&quot;</span><span class="p">,</span>
            <span class="n">client_id</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GOOGLE_CLIENT_ID&quot;</span><span class="p">),</span>
            <span class="n">secret</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GOOGLE_CLIENT_SECRET&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">social_app</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">site</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">Migration</span><span class="p">(</span><span class="n">migrations</span><span class="o">.</span><span class="n">Migration</span><span class="p">):</span>

    <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;feeds&quot;</span><span class="p">,</span> <span class="s2">&quot;0001_initial&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;sites&quot;</span><span class="p">,</span> <span class="s2">&quot;0002_alter_domain_unique&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;socialaccount&quot;</span><span class="p">,</span> <span class="s2">&quot;0001_initial&quot;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">operations</span> <span class="o">=</span> <span class="p">[</span><span class="n">migrations</span><span class="o">.</span><span class="n">RunPython</span><span class="p">(</span><span class="n">create_site</span><span class="p">)]</span>
</code></pre></div>

<p>By storing the secrets as environment variables I can provide a <code>secrets.env</code> file (that's ignored by version control) with the following values:</p>
<div class="highlight"><pre><span></span><code>GOOGLE_CLIENT_ID=&quot;****&quot;
GOOGLE_CLIENT_SECRET=&quot;****&quot;
</code></pre></div>

<p>If I clone the project on a new machine (or want to wipe my DB volume and start
over) I can quickly bootstrap my project with:</p>
<div class="highlight"><pre><span></span><code>$ ./manage.py makemigrations
$ ./manage.py migrate
</code></pre></div>

<p>And Google login (via allauth) should work out of the box (example below)</p>
<p>{{&lt; youtube N_wsfTYaRJI &gt;}}</p>
  </article>
        </main>
        <footer>
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->
        </footer>
</body>
</html>